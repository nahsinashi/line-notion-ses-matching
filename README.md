# LINE x Notion SES マッチングシステム

SES（システムエンジニアリングサービス）営業業務を効率化するための、LINE と Notion を連携したマッチングシステムです。

## システム概要

LINEで受信した案件・要員情報を自動的にNotionデータベースに登録し、AIを活用してマッチングを行います。

### 主な機能

1. **LINE → Notion 自動登録** - テキスト・PDFをAIで解析し、案件/要員を自動判別・登録
2. **2段階要員登録** - テキストとファイルをイニシャル照合で自動紐付け（順序問わず）
3. **AIマッチング** - 案件と要員の自動マッチング（スキルシートPDF解析対応）
4. **承認ワークフロー** - LINEクイックリプライによる承認/却下、パートナー返信追跡
5. **ステータス監視** - Notion上のステータス変更を定期ポーリングで検知・履歴記録
6. **定期配信** - 案件・要員情報のスコアリング配信

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                         LINE Platform                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │パートナーA │  │パートナーB │  │パートナーC │  │ 管理者    │       │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘       │
│       └─────────────┴──────┬──────┴─────────────┘              │
│                            │                                    │
│  ┌─────────────────────────┴─────────────────────────┐         │
│  │         LINE Messaging API (Webhook)              │         │
│  └─────────────────────────┬─────────────────────────┘         │
└────────────────────────────┼────────────────────────────────────┘
                             │
        ┌────────────────────┴────────────────────┐
        ▼                                         ▼
┌───────────────────┐                   ┌───────────────────┐
│  メイン GAS       │                   │  Admin GAS        │
│  (パートナー用)    │                   │  (管理者用)        │
│                   │                   │                   │
│ ・案件/要員登録    │                   │ ・承認ワークフロー   │
│ ・ファイル紐付け   │                   │ ・メッセージバッファ │
│ ・マッチング実行   │                   │ ・パートナー返信転送 │
│ ・ステータス監視   │                   │ ・AI返信判定       │
│ ・定期配信        │                   │                   │
└────────┬──────────┘                   └────────┬──────────┘
         │                                       │
         │       ┌───────────────────┐           │
         │       │   AI APIs         │           │
         ├──────►│ ・Gemini Flash    │◄──────────┤
         │       │ ・Gemini Pro      │           │
         │       │ ・GPT-4o-mini     │           │
         │       │ ・Claude Haiku    │           │
         │       └───────────────────┘           │
         │                                       │
         └───────────────┬───────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────────────┐
         │            Notion API                 │
         │  ┌─────────┐ ┌─────────┐ ┌─────────┐ │
         │  │案件DB   │ │要員DB   │ │提案DB   │ │
         │  └─────────┘ └─────────┘ └─────────┘ │
         │  ┌─────────────────────┐              │
         │  │ステータス変更履歴DB │              │
         │  └─────────────────────┘              │
         └───────────────────────────────────────┘
```

## フォルダ構成

```
line-notion-matching/
├── gas-main/                  # メインGASプロジェクト（パートナー向け）
│   ├── 00_設定.gs              # 共通設定（APIキー・DB ID）※要書き換え
│   ├── 01_フォーム送信時の処理スクリプト.gs
│   ├── 02_フォーム選択肢更新スクリプト.gs
│   ├── 03_AI整形.gs
│   ├── 04_マッチング.gs
│   ├── 05_WebApp.gs
│   ├── 06_LINEマッピング.gs
│   ├── 07_ファイル受信処理.gs
│   ├── 08_LINE通知.gs
│   ├── 09_ステータス監視.gs
│   └── 10_定期配信.gs
├── gas-admin/                 # 管理者GASプロジェクト
│   ├── 00_Config.gs
│   ├── 01_WebApp.gs
│   ├── 02_AdminCommands.gs
│   ├── 03_ApprovalFlow.gs
│   └── 04_AI_Clients.gs
├── prompts/                   # AIプロンプトテンプレート
│   ├── 案件整形プロンプト.txt
│   ├── 要員整形プロンプト.txt
│   └── マッチングプロンプト.txt
├── docs/                      # ドキュメント
│   ├── setup-guide.md         # セットアップガイド
│   └── notion-schema.md       # Notionデータベーススキーマ
├── broadcast-skill/           # 定期配信Pythonスクリプト
├── ses-analysis-skill/        # SES分析レポート生成
└── README.md
```

## セットアップ

詳細な手順は **[docs/setup-guide.md](./docs/setup-guide.md)** を参照してください。

### 必要なもの

- Google アカウント（GAS実行用）
- LINE Developers アカウント（Bot 2つ: パートナー用・管理者用）
- Notion アカウント（Integration作成）
- Google AI Studio APIキー（Gemini）
- OpenAI APIキー（オプション）
- Anthropic APIキー（オプション）

### クイックスタート

1. Notionデータベースを作成 → [スキーマ定義](./docs/notion-schema.md)
2. LINE Bot を作成（2つ）
3. GASプロジェクトにスクリプトをコピー
4. スクリプトプロパティにAPIキーを設定
5. Webhook URLを接続
6. Googleフォームを作成（メンバー用）
7. トリガーを設定

## 使用技術

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| バックエンド | Google Apps Script | メイン処理基盤 |
| メッセージング | LINE Messaging API | Webhook受信、Push通知 |
| データベース | Notion API | データ管理（案件/要員/提案） |
| AI（テキスト整形） | Gemini 2.5 Flash | 高速・低コスト |
| AI（マッチング） | Gemini 2.5 Pro / Flash | PDF解析対応 |
| AI（コマンド解析） | GPT-4o-mini | 低コスト |
| AI（フォールバック） | Claude Haiku | 予備 |
| ファイル保存 | Google Drive API | スキルシートPDF |

## 主要な処理フロー

### LINE経由: 案件/要員登録（パートナー利用）

```
パートナーがLINEで送信 → 管理者GAS（AI分類） → メインGAS（AI整形） → Notion登録 → マッチング起動
```

### LINE経由: 2段階要員登録（パートナー利用）

```
テキスト受信 → イニシャル抽出・一時保存 → ファイル受信 → 照合・紐付け → Notion登録
（逆順にも対応）
```

### フォーム経由: 案件/要員登録（管理者・メンバー利用）

```
Googleフォーム送信 → メインGAS（AI整形） → Notion登録 → マッチング起動
```

### マッチング → 承認

```
候補抽出 → AI分析 → 提案DB登録 → 管理者LINE通知 → 承認/却下 → パートナーへ通知
```

## 注意事項

- GASの実行時間制限（6分）対策として、マッチング処理は遅延実行トリガーを使用
- 大量データ対応のため、Notionクエリにはページネーションを実装
- メッセージの分割送信対策として、admin-systemではバッファリング機能を実装
- スクリプト内のシークレット（APIキー等）はスクリプトプロパティから読み込む設計

## ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [セットアップガイド](./docs/setup-guide.md) | ゼロから構築する手順（非エンジニア向け） |
| [Notionスキーマ](./docs/notion-schema.md) | データベース構造・関数式の定義 |

## ライセンス

MIT License
