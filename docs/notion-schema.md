# Notion Database Schema

このシステムで使用する5つのNotionデータベースの定義です。

---

## 1. 案件DB

SES案件情報を管理するデータベースです。

| プロパティ名 | 型 | 説明 | 設定方法 |
|------------|-----|------|---------|
| **入力不要** | title | 案件名。AIオートフィルで原文から抽出。案件名がない場合は業務内容から生成 | AI自動 |
| **原文** | rich_text | パートナー原文をそのまま保存（改変不可） | LINE/フォーム |
| **サマリー** | rich_text | 営業用テキスト。AIが原文を整形（■区切り） | AI自動 |
| **案件元企業** | rich_text | 案件を送ってきたパートナー企業名 | LINE自動/手動 |
| **ステータス** | select | 案件の進捗状態 | 手動 |
| **担当** | select | 社内担当者 | 手動 |
| **スキル要件** | multi_select | 主要な開発言語のみ（Java, JavaScript, PHP, TypeScript, Python, Go, C#, PM, PMO） | AI自動 |
| **スキル詳細** | rich_text | フレームワーク、DB、ツールなど技術スタック詳細 | AI自動 |
| **原文単価** | number (yen) | 原文から抽出した単価（上位→自社の金額）。範囲は上限値 | AI自動 |
| **営業単価** | number (yen) | 原文単価から一律5万円引き | AI自動 |
| **勤務地** | rich_text | 場所・出社条件（例：基本リモート（月数回渋谷出社）） | AI自動 |
| **リモート** | select | リモート条件の分類 | AI自動 |
| **案件開始** | date | 案件開始時期。即日/ASAPの場合は翌月1日 | AI自動 |
| **案件開始（年月）** | formula | 案件開始から年月のみを表示（YYYY/MM） | 自動計算（後述） |
| **募集人数** | number | 募集人数 | AI自動 |
| **案件回収日** | created_time | ページ作成日時 | 自動 |

### Formula（計算式）

#### 案件開始（年月）

「案件開始」プロパティから年月のみを `YYYY/MM` 形式で表示します。

Notionの数式エディタに以下を入力:

```
if(empty(prop("案件開始")), "", formatDate(prop("案件開始"), "YYYY/MM"))
```

| 参照プロパティ | 出力例 |
|-------------|--------|
| 案件開始 = 2026-04-01 | `2026/04` |
| 案件開始 = 空 | （空欄） |

### ステータス選択肢

| 値 | 色 | 説明 |
|---|---|------|
| 未処理 | gray | 登録直後。AI整形待ち |
| 営業中 | yellow | 営業活動中 |
| 面談調整中 | blue | 面談日程調整中 |
| 決定 | purple | 案件決定 |
| 終了 | red | 案件終了・クローズ |

### 担当者選択肢

| 値 | 色 |
|---|---|
| 髙梨 | green |
| 坂本 | blue |
| 堀江 | yellow |

> **カスタマイズ**: 担当者名は自社のメンバーに変更してください。

### リモート選択肢

| 値 | 色 |
|---|---|
| フルリモート | blue |
| ハイブリッド | green |
| 不可 | default |

---

## 2. 要員DB

SES要員（エンジニア）情報を管理するデータベースです。

| プロパティ名 | 型 | 説明 | 設定方法 |
|------------|-----|------|---------|
| **要員名** | title | イニシャル_最寄駅の形式（例：K.S_渋谷）。コード名がある場合はそのまま使用 | AI自動 |
| **原文** | rich_text | パートナー原文をそのまま保存（改変不可） | LINE/フォーム |
| **サマリー** | rich_text | 営業用テキスト。AIが原文を整形（■区切り） | AI自動 |
| **要員元企業** | rich_text | 要員を送ってきたパートナー企業名 | LINE自動/手動 |
| **ステータス** | select | 要員の進捗状態 | 手動 |
| **担当** | select | 社内担当者 | 手動 |
| **スキル概要** | multi_select | 主要な開発言語のみ（Java, JavaScript, PHP, TypeScript, Python, Go, C#, PM, PMO） | AI自動 |
| **スキル詳細** | rich_text | フレームワーク、DB、ツールなど技術スタック詳細 | AI自動 |
| **希望単価** | number (yen) | 原文から抽出した単価（所属元→自社の金額）。範囲は上限値 | AI自動 |
| **営業単価** | number (yen) | 希望単価から一律5万円アップ | AI自動 |
| **スキルシート** | files | スキルシートPDFファイル | LINE自動/手動 |
| **稼働開始** | date | 稼働開始時期。即日/ASAPの場合は翌月1日 | AI自動 |
| **稼働開始（年月）** | formula | 稼働開始から年月のみを表示（YYYY/MM） | 自動計算（後述） |
| **要員回収日** | created_time | ページ作成日時 | 自動 |

### Formula（計算式）

#### 稼働開始（年月）

「稼働開始」プロパティから年月のみを `YYYY/MM` 形式で表示します。

```
if(empty(prop("稼働開始")), "", formatDate(prop("稼働開始"), "YYYY/MM"))
```

| 参照プロパティ | 出力例 |
|-------------|--------|
| 稼働開始 = 2026-04-01 | `2026/04` |
| 稼働開始 = 空 | （空欄） |

### ステータス選択肢

| 値 | 色 | 説明 |
|---|---|------|
| 未処理 | gray | 登録直後。AI整形待ち |
| 営業中 | yellow | 営業活動中 |
| 面談調整中 | blue | 面談日程調整中 |
| オファー | purple | オファー段階 |
| 終了 | red | 要員終了・クローズ |

---

## 3. 提案DB

案件と要員のマッチング提案を管理するデータベースです。

| プロパティ名 | 型 | 説明 | 設定方法 |
|------------|-----|------|---------|
| **提案名** | title | 提案の名前（通常は「案件名 × 要員名」） | 手動/AI自動 |
| **案件DB** | relation → 案件DB | 紐付く案件 | 手動/AI自動 |
| **要員DB** | relation → 要員DB | 紐付く要員 | 手動/AI自動 |
| **ステータス** | select | 提案の進捗状態 | 手動/ボタン |
| **メモ** | rich_text | 面談日程、アクション、気づきなど自由記述 | 手動 |
| **提案日** | date | 提案を行った日付 | 手動 |
| **面談設定日** | date | 面談の設定日 | 手動 |
| **提案作成日** | created_time | ページ作成日時 | 自動 |
| **案件担当** | formula | 案件DB側の担当者を自動表示 | 自動計算（後述） |
| **要員担当** | formula | 要員DB側の担当者を自動表示 | 自動計算（後述） |
| **案件元企業** | formula | 案件DB側の企業名を自動表示 | 自動計算（後述） |
| **要員元企業** | formula | 要員DB側の企業名を自動表示 | 自動計算（後述） |
| **案件単価** | formula | 案件DBの原文単価を自動表示 | 自動計算（後述） |
| **要員希望単価** | formula | 要員DBの希望単価を自動表示 | 自動計算（後述） |
| **粗利見込** | formula | 案件単価 - 要員希望単価 | 自動計算（後述） |
| **1週間経過** | formula | 提案日から7日以上経過で「⚠️ 1週間経過」表示 | 自動計算（後述） |
| **要員へ案件確認** | formula | 案件担当と要員担当が異なる場合「⚠️ 要確認」表示 | 自動計算（後述） |

### Formula（計算式）

> **重要**: 提案DBのformulaはリレーション先（案件DB・要員DB）のプロパティを参照します。
> リレーション（「案件DB」「要員DB」プロパティ）を先に設定してから、formulaを追加してください。

#### 案件担当

案件DBにリレーションされたレコードの「担当」を表示します。

```
if(
  prop("案件DB").length() > 0,
  prop("案件DB").first().prop("担当"),
  ""
)
```

#### 要員担当

要員DBにリレーションされたレコードの「担当」を表示します。

```
if(
  prop("要員DB").length() > 0,
  prop("要員DB")
    .map(current.prop("担当"))
    .join(", "),
  ""
)
```

#### 案件元企業

案件DBにリレーションされたレコードの「案件元企業」を表示します。

```
if(
  prop("案件DB").length() > 0,
  prop("案件DB")
    .map(current.prop("案件元企業"))
    .join(", "),
  ""
)
```

#### 要員元企業

要員DBにリレーションされたレコードの「要員元企業」を表示します。

```
if(
  prop("要員DB").length() > 0,
  prop("要員DB").at(0).prop("要員元企業"),
  ""
)
```

#### 案件単価

案件DBの「原文単価」を `¥` 付きで表示します。

```
if(
  prop("案件DB").length() > 0 and
  not empty(prop("案件DB").at(0).prop("原文単価")),
  "¥" + format(prop("案件DB").at(0).prop("原文単価")),
  "¥0"
)
```

#### 要員希望単価

要員DBの「希望単価」を表示します。

```
if(
  prop("要員DB").length() > 0 and
  not empty(prop("要員DB").first().prop("希望単価")),
  format(prop("要員DB").first().prop("希望単価")),
  "—"
)
```

#### 粗利見込

案件の原文単価から要員の希望単価を引いた差額を表示します。

```
lets(
  projectPrice, prop("案件DB").first().prop("原文単価"),
  personnelPrice, prop("要員DB").first().prop("希望単価"),
  if(
    empty(prop("案件DB")) or empty(prop("要員DB")) or
    empty(projectPrice) or empty(personnelPrice),
    "計算不可",
    "¥" + format(round(projectPrice - personnelPrice, 0))
  )
)
```

| 例 | 結果 |
|----|------|
| 案件単価 ¥700,000、要員希望 ¥600,000 | `¥100000` |
| どちらか未設定 | `計算不可` |

#### 1週間経過

提案日から7日以上経過している場合に警告を表示します。

```
if(
  empty(prop("提案日")),
  "",
  if(
    dateBetween(now(), prop("提案日"), "days") >= 7,
    "⚠️ 1週間経過",
    ""
  )
)
```

#### 要員へ案件確認

案件担当と要員担当が異なる場合に警告を表示します（クロス担当の提案を見逃さないため）。

```
if(
  prop("ステータス") == "候補" and
  prop("案件担当") != prop("要員担当"),
  "⚠️ 要確認",
  ""
)
```

> **注意**: この式は他のformulaプロパティ（案件担当・要員担当）を参照しています。案件担当・要員担当のformulaを先に作成してください。

### ステータス選択肢

| 値 | 色 | 説明 |
|---|---|------|
| 候補 | gray | AIマッチングで生成された候補 |
| 提案中 | pink | パートナーに提案済み |
| 面談 | yellow | 面談設定済み |
| 結果待ち | blue | 面談後の結果待ち |
| 見送り | red | 見送り |
| 辞退 | orange | 辞退 |
| 決定 | purple | 決定 |

### リレーション設定

- **案件DB**: 案件DBと `single_property` 型で紐付け
- **要員DB**: 要員DBと `single_property` 型で紐付け

---

## 4. ステータス変更履歴DB

案件・要員・提案のステータス変更を自動記録するデータベースです。

| プロパティ名 | 型 | 説明 | 設定方法 |
|------------|-----|------|---------|
| **レコード名** | title | 変更されたレコードの名前 | 自動 |
| **DB種別** | select | どのDBのレコードか（提案/要員/案件） | 自動 |
| **旧ステータス** | select | 変更前のステータス | 自動 |
| **新ステータス** | select | 変更後のステータス | 自動 |
| **変更日時** | date | 変更が検知された日時 | 自動 |
| **レコードID** | rich_text | Notionページ ID | 自動 |
| **備考** | rich_text | 変更に関する備考 | 自動 |

### DB種別選択肢

| 値 | 色 |
|---|---|
| 提案 | yellow |
| 要員 | red |
| 案件 | default |

---

## 5. 会社DB（オプション）

> **注意**: 現在の実装ではLINE UserIDと企業名のマッピングはGASのスクリプトプロパティで管理しています。会社DBは将来の拡張用です。コードでは `COMPANY_DB_ID` として参照されていますが、必須ではありません。

---

## データベース作成手順

### 方法1: 手動作成

1. Notionで新しいページを作成
2. `/database` コマンドでフルページデータベースを作成
3. 上記のスキーマに従ってプロパティを追加
4. select/multi_selectの選択肢を設定

### 方法2: テンプレートから複製（推奨）

> TODO: Notionテンプレートリンクを追加予定

### プロパティ追加の注意事項

- **title型**: データベースに1つだけ。案件DB=「入力不要」、要員DB=「要員名」、提案DB=「提案名」
- **formula型**: 他のプロパティを参照する計算式。リレーション設定後に追加
- **relation型**: 提案DBから案件DB/要員DBへのリレーションを設定
- **created_time型**: 自動で設定される。手動作成不要
- **select/multi_select**: 選択肢は上記の表を参考に作成

### プロパティ作成の推奨順序

formulaはリレーション先のプロパティを参照するため、作成順序が重要です。

```
1. 案件DB: title → rich_text → select → multi_select → number → date → formula
2. 要員DB: title → rich_text → select → multi_select → number → date → files → formula
3. 提案DB:
   a. title → select → rich_text → date → created_time
   b. relation（案件DB、要員DB）
   c. formula（案件担当、要員担当を先に作成）
   d. formula（要員へ案件確認を最後に作成 ※案件担当・要員担当を参照するため）
4. ステータス変更履歴DB: title → select → rich_text → date
```

### データベースID の取得方法

1. Notionでデータベースページを開く
2. URLの `notion.so/` 以降の32文字がデータベースID
   - 例: `https://www.notion.so/2c2c01f8776980138dc0ea41dac2c119`
   - ID: `2c2c01f8776980138dc0ea41dac2c119`
3. GASのスクリプトプロパティに登録:
   - `CASE_DB_ID` = 案件DBのID
   - `STAFF_DB_ID` = 要員DBのID
   - `PROPOSAL_DB_ID` = 提案DBのID
   - `STATUS_HISTORY_DB_ID` = ステータス変更履歴DBのID
